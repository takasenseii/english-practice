(function () {
  "use strict";

  const CAPITAL_ITEMS = [
    {
      text: "we visited london in april.",
      corrected: "We visited London in April.",
      explanation: "Capitalize the first letter of the sentence, proper nouns (London), and months (April)."
    },
    {
      text: "my sister speaks spanish and german.",
      corrected: "My sister speaks Spanish and German.",
      explanation: "Capitalize the first letter of the sentence and languages (Spanish, German)."
    },
    {
      text: "yesterday, president biden met with the prime minister.",
      corrected: "Yesterday, President Biden met with the Prime Minister.",
      explanation: "Capitalize sentence start and formal titles before names (President, Prime Minister)."
    },
    {
      text: "on monday, we will celebrate christmas in sweden.",
      corrected: "On Monday, we will celebrate Christmas in Sweden.",
      explanation: "Capitalize days, holidays, and country names."
    },
    {
      text: "he read 'harry potter' by j.k. rowling.",
      corrected: "He read 'Harry Potter' by J.K. Rowling.",
      explanation: "Capitalize titles and proper names."
    },
    {
      text: "the un is based in new york city.",
      corrected: "The UN is based in New York City.",
      explanation: "Capitalize sentence start, acronyms (UN), and cities."
    },
    {
      text: "we drove south until we reached the pacific ocean.",
      corrected: "We drove south until we reached the Pacific Ocean.",
      explanation: "Capitalize geographic names (Pacific Ocean)."
    },
    {
      text: "every january, the university opens new courses.",
      corrected: "Every January, the University opens new courses.",
      explanation: "Capitalize months and institutions when used as proper names."
    }
  ];

  function generateCapital(n = 10) {
    return shuffle(CAPITAL_ITEMS).slice(0, n).map(x => ({
      prompt: x.text,
      corrected: x.corrected,
      explanation: x.explanation
    }));
  }

  function render(list, mount) {
    mount.innerHTML = "";

    const container = document.createElement("div");
    container.className = "container";

    const scoreBox = document.createElement("div");
    scoreBox.id = "scoreBox";
    scoreBox.style.marginBottom = "12px";
    container.appendChild(scoreBox);

    const listEl = document.createElement("div");
    listEl.id = "list";
    container.appendChild(listEl);

    list.forEach((item, idx) => {
      const card = document.createElement("div");
      card.className = "card";

      const row = document.createElement("div");
      row.className = "row q";

      const p = document.createElement("div");
      p.className = "prompt";
      p.textContent = item.prompt;

      const ans = document.createElement("input");
      ans.className = "ans";
      ans.placeholder = "Correct capitalisation";

      const mark = document.createElement("span");
      mark.className = "mark";

      row.appendChild(p);
      row.appendChild(ans);
      row.appendChild(mark);
      card.appendChild(row);

      const exp = document.createElement("div");
      exp.className = "exp";
      exp.style.display = "none";
      exp.textContent = item.explanation;
      card.appendChild(exp);

      listEl.appendChild(card);
    });

    const btnRow = document.createElement("div");
    btnRow.style.marginTop = "12px";

    const checkBtn = document.createElement("button");
    checkBtn.textContent = "Check answers";
    checkBtn.onclick = () => checkAll(list, container);

    const tryBtn = document.createElement("button");
    tryBtn.textContent = "Try again";
    tryBtn.style.marginLeft = "10px";
    tryBtn.onclick = () => window.mountCapital(mount);

    const expBtn = document.createElement("button");
    expBtn.textContent = "Show explanations";
    expBtn.style.marginLeft = "10px";
    expBtn.onclick = () => toggleExplanations(container, expBtn);

    btnRow.appendChild(checkBtn);
    btnRow.appendChild(tryBtn);
    btnRow.appendChild(expBtn);

    container.appendChild(btnRow);

    mount.appendChild(container);

    scoreBox.textContent = "";
  }

  function checkAll(list, container) {
    const rows = container.querySelectorAll(".card");
    let correct = 0;
    let total = list.length;

    rows.forEach((card, i) => {
      const inp = card.querySelector(".ans");
      const mark = card.querySelector(".mark");
      const exp = card.querySelector(".exp");

      const user = String(inp.value).trim();
      const target = list[i].corrected.trim();

      if (user === target) {
        mark.textContent = "✔";
        mark.className = "mark ok";
        correct++;
        stats.add("capitalisation", true, target);
      } else {
        mark.textContent = "✖";
        mark.className = "mark bad";
        stats.add("capitalisation", false, { prompt: list[i].prompt, correct: target, user });
        exp.style.display = "block";
      }
    });

    const scoreBox = container.querySelector("#scoreBox");
    scoreBox.textContent = `Score: ${correct} / ${total}`;
  }

  function toggleExplanations(container, btn) {
    const all = container.querySelectorAll(".exp");
    let visible = [...all].some(e => e.style.display === "block");

    all.forEach(e => e.style.display = visible ? "none" : "block");
    btn.textContent = visible ? "Show explanations" : "Hide explanations";
  }

  window.mountCapital = function (mount) {
    render(generateCapital(8), mount);
  };

})();
